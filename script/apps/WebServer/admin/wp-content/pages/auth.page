<?npl
--[[
Title: auth/login page
Author: LiXizhi
Date: 2016/5/10
]]

wp_enqueue_script("angular", "/wp-includes/js/angular/angular.min.js");
<<<<<<< .mine
wp_enqueue_script("satellizer", "/wp-includes/js/oauth/satellizer.min.js");
?>
=======
wp_enqueue_script("angular-route", "/wp-includes/js/angular/angular-route.min.js");
wp_enqueue_script("angular-ui", "/wp-includes/js/angular/ui-bootstrap-tpls-1.3.3.min.js");
wp_enqueue_script("satellizer", "/wp-includes/js/oauth/satellizer.min.js");
?>
>>>>>>> .r21467
<script>
	angular.module('Auth', ['satellizer', 'ui.bootstrap'])
	.config(function($authProvider) {
		$authProvider.facebook({
			url: "/ajax/auth/facebook",
			clientId: '128754717528463',
			redirectUri: window.location.origin + '/auth',
		 });
		$authProvider.google({
			url: "/ajax/auth/google",
			clientId: '638766295212-f99rcpljr68ld4pfmme4qrh2ru0ke4nd.apps.googleusercontent.com',
			redirectUri: window.location.origin + '/auth',
		});
		$authProvider.github({
			url: "/ajax/auth/github",
			clientId: '44ed8acc9b71e36f47d8',
			redirectUri: window.location.origin + '/auth',
		});
	})
	.factory('Account', function($http) {
		return {
			getProfile: function() {
				return $http.get('/ajax/auth/api_me');
			},
			updateProfile: function(profileData) {
				return $http.put('/ajax/auth/api_me', profileData);
			}
		};
	})
	.controller('ModalLoginCtrl', function ($scope, $auth, $uibModalInstance) {
		$scope.isAuthenticating = false;
		$scope.authenticate = function(provider) {
			$scope.isAuthenticating = true;
			$auth.authenticate(provider)
				.then(function() {
					$uibModalInstance.close(provider);
				})
				.catch(function(error) {
					$uibModalInstance.dismiss("error", error);
				});
		};
	})
	.controller('LoginCtrl', function($scope, $auth, $uibModal, Account) {
		$scope.user = {};
		$scope.getProfile = function() {
			Account.getProfile()
				.then(function(response) {
					$scope.user = response.data;
				})
				.catch(function(response) {
					$scope.user = null;
					if(response.data)
						alert(response.data.message || "some error!");
				});
		};
		$scope.logout = function() {
			if (!$auth.isAuthenticated()) { return; }
			$auth.logout().then(function() { 
				alert("you are signed out!") 
			});	
		};
		$scope.isAuthenticated = function() {
		  return $auth.isAuthenticated();
		};
		$scope.login = function() {
			$uibModal.open({
				templateUrl : "/wp-content/pages/auth/login.html",
				controller: "ModalLoginCtrl",
			}).result.then(function (provider) {
				alert('You have successfully signed in with ' + provider + '!');
			}, function (text, error) {
				if (error && error.error) {
					// Popup error - invalid redirect_uri, pressed cancel button, etc.
					alert(error.error);
				} else if (error && error.data) {
					// HTTP response error from server
					alert(error.data.message || "some error!");
				}
			});
		};
		if($scope.isAuthenticated())
			$scope.getProfile();
	})
</script>
<div ng-app="Auth" style="margin-top:10px;" class="form-horizontal">
	<div ng-controller="LoginCtrl as Login">
		<div ng-if="!isAuthenticated()" >
			<ul class="nav navbar-nav pull-right">
				<li><a ng-click="login()">Login</a></li>
				<li><a href="/#/signup">Sign up</a></li>
			</ul>
		</div>
		<div ng-if="isAuthenticated()" >
			<ul class="nav navbar-nav pull-right">
				<li><a ng-click="logout()">Logout</a></li>
			</ul>
			<div>
				<label class="control-label">Profile Picture</label>
				<img class="profile-picture" ng-src="{{user.picture || 'http://placehold.it/100x100'}}">
			</div>
		</div>
	</div>
<<<<<<< .mine
</div>
<?

?>=======
</div>>>>>>>> .r21467
